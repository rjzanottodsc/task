<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestor de Atividades Diárias</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111827">

  <!-- Supabase SDK (UMD expõe window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0/dist/umd/supabase.js"></script>

  <!-- Client Supabase -->
  <script>
    const SUPABASE_URL = "https://unsjrvghzwkxyiveaypl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuc2pydmdoendreHlpdmVheXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NDY4MjEsImV4cCI6MjA3MzEyMjgyMX0.erQdiaJWdQC4bG7KnKEwP8VwDVCh7ZKxoWHvxbk2zzU";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #111827; color: #e5e7eb; }
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

    .activity-block {
      position: absolute; height: 100%;
      background-color: #3b82f6; border-radius: 4px; opacity: 0.8;
      transition: all 0.2s ease-in-out; cursor: pointer; overflow: hidden;
      color: white; font-size: 10px; padding-left: 4px; box-sizing: border-box;
      border: 1px solid #1e40af; white-space: nowrap; text-overflow: ellipsis;
    }
    .activity-block:hover { opacity: 1; transform: scaleY(1.1); z-index: 10; }

    /* Esconde a interface principal até autenticar */
    #main-content { display: none; }
  </style>
</head>
<body class="antialiased">
  <div class="container mx-auto p-4 md:p-8 max-w-5xl">

    <!-- Seção de Login / Usuário -->
    <section id="user-section" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <!-- VIEW: Login (Auth real) -->
      <div id="login-view">
        <h2 class="text-xl font-semibold text-white mb-2">Bem-vindo(a)!</h2>
        <p class="text-gray-400 mb-4">Entre com seu e-mail ou use Google para começar.</p>

        <form id="email-login-form" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
          <input type="email" id="email-input" placeholder="seuemail@dominio.com" required
                 class="flex-grow bg-gray-700 border-gray-600 rounded-md text-white p-2" />
          <button class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">
            Enviar código
          </button>
        </form>

        <p id="otp-info" class="text-gray-400 mt-2 hidden">
          Enviamos um link de acesso para o seu e-mail. Clique para entrar.
        </p>

        <div class="mt-4">
          <button id="google-btn" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg">
            Entrar com Google
          </button>
        </div>
      </div>

      <!-- VIEW: Bem-vindo -->
      <div id="welcome-view" class="hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-white">Gestor de Rotinas</h1>
            <p class="text-gray-400 mt-1">
              Usuário: <span id="current-user-span" class="font-semibold text-blue-300"></span>
            </p>
          </div>
          <div class="flex items-center gap-2 sm:gap-3 mt-4 sm:mt-0">
            <input type="date" id="date-picker" class="bg-gray-700 border-gray-600 rounded-md text-white p-2" />
            <button id="logout-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-lg">
              Sair
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Conteúdo Principal -->
    <main id="main-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Coluna de Formulário e Gráfico -->
      <div class="flex flex-col gap-8">
        <section id="form-section" class="bg-gray-800 p-6 rounded-lg shadow-lg">
          <h2 class="text-xl font-semibold mb-4 text-white">Adicionar/Editar Atividade</h2>
          <form id="activity-form" class="space-y-4">
            <input type="hidden" id="activity-id" />
            <div>
              <label for="description" class="block text-sm font-medium text-gray-300">Descrição</label>
              <input type="text" id="description" name="description" required
                     class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-white p-2" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="start-time" class="block text-sm font-medium text-gray-300">Início</label>
                <input type="time" id="start-time" name="start-time" required
                       class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-white p-2" />
              </div>
              <div>
                <label for="end-time" class="block text-sm font-medium text-gray-300">Término</label>
                <input type="time" id="end-time" name="end-time" required
                       class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-white p-2" />
              </div>
            </div>
            <div class="flex justify-end space-x-3 pt-2">
              <button type="button" id="cancel-edit-btn"
                      class="hidden py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-lg">
                Cancelar
              </button>
              <button type="submit"
                      class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">
                Salvar Atividade
              </button>
            </div>
          </form>
        </section>

        <section id="chart-section" class="bg-gray-800 p-6 rounded-lg shadow-lg">
          <h2 class="text-xl font-semibold mb-4 text-white">Linha do Tempo do Dia</h2>
          <div id="summary" class="flex justify-around mb-4 text-center text-sm md:text-base">
            <div>
              <span class="block font-bold text-green-400" id="active-time">0h 0m</span>
              <span class="text-gray-400">Tempo Ativo</span>
            </div>
            <div>
              <span class="block font-bold text-yellow-400" id="idle-time">24h 0m</span>
              <span class="text-gray-400">Tempo Ocioso</span>
            </div>
          </div>
          <div class="relative w-full h-10 bg-gray-700 rounded-lg overflow-hidden" id="timeline-container"></div>
          <div class="flex justify-between text-xs text-gray-400 mt-2">
            <span>00:00</span><span>03:00</span><span>06:00</span><span>09:00</span><span>12:00</span><span>15:00</span><span>18:00</span><span>21:00</span><span>24:00</span>
          </div>
        </section>
      </div>

      <!-- Coluna da Lista de Atividades -->
      <div class="flex flex-col gap-8">
        <section id="list-section" class="bg-gray-800 p-6 rounded-lg shadow-lg">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-3">
            <h2 class="text-xl font-semibold text-white">Atividades do Dia</h2>
            <div class="flex gap-2">
              <button id="export-btn" class="py-1 px-3 bg-gray-700 hover:bg-gray-600 rounded">Exportar JSON</button>
              <label class="py-1 px-3 bg-gray-700 hover:bg-gray-600 rounded cursor-pointer">
                Importar JSON
                <input id="import-input" type="file" accept="application/json" class="hidden" />
              </label>
            </div>
          </div>
          <div id="activities-list" class="space-y-3 max-h-[30rem] lg:max-h-full overflow-y-auto pr-2"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ======= UI elements =======
      const loginView = document.getElementById('login-view');
      const welcomeView = document.getElementById('welcome-view');
      const currentUserSpan = document.getElementById('current-user-span');
      const logoutBtn = document.getElementById('logout-btn');
      const mainContent = document.getElementById('main-content');
      const datePicker = document.getElementById('date-picker');

      const form = document.getElementById('activity-form');
      const activityIdInput = document.getElementById('activity-id');
      const descriptionInput = document.getElementById('description');
      const startTimeInput = document.getElementById('start-time');
      const endTimeInput = document.getElementById('end-time');
      const cancelEditBtn = document.getElementById('cancel-edit-btn');
      const activitiesList = document.getElementById('activities-list');
      const timelineContainer = document.getElementById('timeline-container');
      const activeTimeEl = document.getElementById('active-time');
      const idleTimeEl = document.getElementById('idle-time');

      const emailForm = document.getElementById('email-login-form');
      const emailInput = document.getElementById('email-input');
      const otpInfo = document.getElementById('otp-info');
      const googleBtn = document.getElementById('google-btn');

      const exportBtn = document.getElementById('export-btn');
      const importInput = document.getElementById('import-input');

      // ======= Estado =======
      let appData;
      try {
        appData = JSON.parse(localStorage.getItem('appData')) || { users: {}, currentUser: null };
      } catch {
        appData = { users: {}, currentUser: null };
      }

      let selectedDate = todayLocalISO();
      let currentUserEmail = null;

      // ======= Helpers =======
      function save() {
        localStorage.setItem('appData', JSON.stringify(appData));
      }

      const timeToMinutes = (time) => {
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + minutes;
      };
      const minutesToHoursMinutes = (totalMinutes) => {
        if (totalMinutes < 0) totalMinutes = 0;
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${hours}h ${minutes}m`;
      };
      const todayLocalISO = () => {
        const d = new Date();
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().split('T')[0];
      };
      const mergeIntervals = (intervals) => {
        if (!intervals.length) return [];
        intervals.sort((a,b) => a[0]-b[0]);
        const merged = [intervals[0].slice()];
        for (let i=1;i<intervals.length;i++){
          const [s,e] = intervals[i];
          const last = merged[merged.length-1];
          if (s <= last[1]) last[1] = Math.max(last[1], e);
          else merged.push([s,e]);
        }
        return merged;
      };
      const hasOverlap = (list, start, end, ignoreId=null) => {
        const s = timeToMinutes(start), e = timeToMinutes(end);
        return list.some(a => {
          if (ignoreId && a.id === ignoreId) return false;
          const as = timeToMinutes(a.startTime), ae = timeToMinutes(a.endTime);
          return Math.max(s, as) < Math.min(e, ae);
        });
      };

      function showMainApp() {
        loginView.classList.add('hidden');
        welcomeView.classList.remove('hidden');
        mainContent.style.display = 'grid';
        currentUserSpan.textContent = currentUserEmail || appData.currentUser || '';
        datePicker.value = selectedDate;
      }
      function showLogin() {
        appData.currentUser = null; save();
        loginView.classList.remove('hidden');
        welcomeView.classList.add('hidden');
        mainContent.style.display = 'none';
        if (emailInput) emailInput.value = '';
        currentUserSpan.textContent = '';
      }

      // ======= Render =======
      function render() {
        if (!appData.currentUser) return;
        appData.users[appData.currentUser] = appData.users[appData.currentUser] || {};
        appData.users[appData.currentUser][selectedDate] = appData.users[appData.currentUser][selectedDate] || [];

        const activities = appData.users[appData.currentUser][selectedDate];
        activities.sort((a,b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));

        activitiesList.innerHTML = '';
        timelineContainer.innerHTML = '';

        if (activities.length === 0) {
          const p = document.createElement('p');
          p.className = 'text-gray-500 text-center py-4';
          p.textContent = 'Nenhuma atividade para este dia.';
          activitiesList.appendChild(p);
        }

        // Lista (sem innerHTML para evitar XSS)
        activities.forEach(activity => {
          const activityElement = document.createElement('div');
          activityElement.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center transition hover:bg-gray-600';

          // Esquerda
          const left = document.createElement('div');
          const title = document.createElement('p');
          title.className = 'font-medium text-white';
          title.textContent = activity.description;
          const subtitle = document.createElement('p');
          subtitle.className = 'text-sm text-gray-400';
          subtitle.textContent = `${activity.startTime} - ${activity.endTime}`;
          left.appendChild(title); left.appendChild(subtitle);

          // Direita
          const right = document.createElement('div'); right.className = 'space-x-2';

          const editBtn = document.createElement('button');
          editBtn.dataset.id = activity.id;
          editBtn.className = 'edit-btn p-2 text-gray-400 hover:text-blue-400';
          editBtn.setAttribute('aria-label', 'Editar');
          editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>';

          const delBtn = document.createElement('button');
          delBtn.dataset.id = activity.id;
          delBtn.className = 'delete-btn p-2 text-gray-400 hover:text-red-400';
          delBtn.setAttribute('aria-label', 'Excluir');
          delBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>';

          right.appendChild(editBtn); right.appendChild(delBtn);
          activityElement.appendChild(left); activityElement.appendChild(right);
          activitiesList.appendChild(activityElement);

          // Timeline
          const startMinutes = timeToMinutes(activity.startTime);
          const endMinutes = timeToMinutes(activity.endTime);
          const duration = endMinutes > startMinutes ? endMinutes - startMinutes : 0;

          const block = document.createElement('div');
          block.className = 'activity-block';
          block.style.left = `${(startMinutes / 1440) * 100}%`;
          block.style.width = `${(duration / 1440) * 100}%`;
          block.title = `${activity.description} (${activity.startTime} - ${activity.endTime})`;
          block.textContent = activity.description;
          timelineContainer.appendChild(block);
        });

        // Soma do tempo ativo (união de intervalos)
        const intervals = activities
          .map(a => [timeToMinutes(a.startTime), timeToMinutes(a.endTime)])
          .filter(([s,e]) => e > s);
        const merged = mergeIntervals(intervals);
        const totalActiveMinutes = merged.reduce((acc,[s,e]) => acc + (e - s), 0);
        const totalIdleMinutes = 1440 - totalActiveMinutes;

        activeTimeEl.textContent = minutesToHoursMinutes(totalActiveMinutes);
        idleTimeEl.textContent = minutesToHoursMinutes(totalIdleMinutes);

        save();
      }

      // ======= Supabase Auth =======
      async function updateSessionUI() {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) console.warn('auth.getUser error:', error?.message);

        if (user) {
          currentUserEmail = user.email || user.user_metadata?.email || '(sem e-mail)';

          // (opcional) garante profile; ignore erro se tabela não existir
          try {
            await supabase.from('profiles').upsert({ id: user.id, full_name: currentUserEmail }).select();
          } catch (e) {
            // ok ignorar se não houver tabela/permissão
          }

          appData.users = appData.users || {};
          appData.currentUser = user.id;

          if (!selectedDate) selectedDate = todayLocalISO();

          showMainApp();
          await loadActivitiesForSelectedDate();
        } else {
          showLogin();
        }
      }

      // ======= CRUD Activities (Supabase) =======
      async function loadActivitiesForSelectedDate() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from('activities')
          .select('*')
          .eq('user_id', user.id)
          .eq('activity_date', selectedDate)
          .order('start_time', { ascending: true });

        appData.users = appData.users || {};
        appData.users[user.id] = appData.users[user.id] || {};

        if (error) {
          console.error('loadActivities error:', error);
          const cached = appData.users[user.id][selectedDate] || [];
          appData.users[user.id][selectedDate] = cached;
        } else {
          appData.users[user.id][selectedDate] = (data || []).map(row => ({
            id: row.id,
            description: row.description,
            startTime: row.start_time,
            endTime: row.end_time
          }));
        }
        save();
        render();
      }

      // ======= Listeners =======
      if (googleBtn) {
        googleBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          const { error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
          if (error) alert(error.message);
        });
      }

      if (emailForm) {
        emailForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = emailInput.value.trim();
          if (!email) return;
          const { error } = await supabase.auth.signInWithOtp({ email });
          if (error) alert(error.message);
          else otpInfo.classList.remove('hidden');
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          await supabase.auth.signOut();
          showLogin();
        });
      }

      if (datePicker) {
        datePicker.addEventListener('change', async (e) => {
          selectedDate = e.target.value || todayLocalISO();
          resetForm();
          await loadActivitiesForSelectedDate();
        });
      }

      function resetForm() {
        form.reset();
        activityIdInput.value = '';
        cancelEditBtn.classList.add('hidden');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return alert('Faça login primeiro.');

        const activities = appData.users[user.id]?.[selectedDate] || [];
        const id = activityIdInput.value;
        const description = descriptionInput.value.trim();
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;

        if (!description || !startTime || !endTime || timeToMinutes(startTime) >= timeToMinutes(endTime)) {
          alert('Preencha os campos corretamente. O término deve ser após o início.');
          return;
        }

        // valida sobreposição
        if (hasOverlap(activities, startTime, endTime, id || null)) {
          alert('Este intervalo conflita com outra atividade.');
          return;
        }

        if (id) {
          const { error } = await supabase
            .from('activities')
            .update({
              description,
              start_time: startTime,
              end_time: endTime,
              updated_at: new Date().toISOString()
            })
            .eq('id', id)
            .eq('user_id', user.id);

          if (error) return alert('Erro ao atualizar: ' + error.message);
        } else {
          const { error } = await supabase
            .from('activities')
            .insert({
              user_id: user.id,
              activity_date: selectedDate,
              description,
              start_time: startTime,
              end_time: endTime
            });

          if (error) return alert('Erro ao salvar: ' + error.message);
        }

        resetForm();
        await loadActivitiesForSelectedDate();
      });

      activitiesList.addEventListener('click', async (e) => {
        const target = e.target.closest('button');
        if (!target) return;

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const activities = appData.users[user.id]?.[selectedDate] || [];
        const id = target.dataset.id;

        if (target.classList.contains('edit-btn')) {
          const activity = activities.find(a => a.id === id);
          if (!activity) return;
          activityIdInput.value = activity.id;
          descriptionInput.value = activity.description;
          startTimeInput.value = activity.startTime;
          endTimeInput.value = activity.endTime;
          cancelEditBtn.classList.remove('hidden');
          form.scrollIntoView({ behavior: 'smooth' });
          return;
        }

        if (target.classList.contains('delete-btn')) {
          if (confirm('Tem certeza que deseja remover esta atividade?')) {
            const { error } = await supabase
              .from('activities')
              .delete()
              .eq('id', id)
              .eq('user_id', user.id);

            if (error) return alert('Erro ao excluir: ' + error.message);
            await loadActivitiesForSelectedDate();
          }
        }
      });

      cancelEditBtn.addEventListener('click', resetForm);

      // Exportar JSON
      exportBtn.addEventListener('click', async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        const all = appData.users?.[user.id] || {};
        const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `atividades_${user.id}.json`; a.click();
        URL.revokeObjectURL(url);
      });

      // Importar JSON
      importInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const text = await file.text();
        let imported;
        try { imported = JSON.parse(text); }
        catch { return alert('Arquivo inválido.'); }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const rows = [];
        for (const [dt, arr] of Object.entries(imported)) {
          for (const item of arr) {
            if (item.description && item.startTime && item.endTime) {
              rows.push({
                user_id: user.id,
                activity_date: dt,
                description: item.description,
                start_time: item.startTime,
                end_time: item.endTime
              });
            }
          }
        }
        if (rows.length) {
          const { error } = await supabase.from('activities').insert(rows);
          if (error) return alert('Erro ao importar: ' + error.message);
        }
        await loadActivitiesForSelectedDate();
        alert('Importação concluída!');
        e.target.value = ''; // reset input
      });

      // Sessão inicial + reatividade
      updateSessionUI();
      supabase.auth.onAuthStateChange((_event, _session) => updateSessionUI());

      // PWA: registrar Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./service-worker.js");
      }
    });
  </script>
</body>
</html>
